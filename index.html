<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Bhavish & Khushboo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen pb-6">
    <div class="max-w-2xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-slate-800 mb-1">üí∞ Expense Tracker</h1>
            <p class="text-sm text-slate-600">Bhavish & Khushboo</p>
        </div>

        <!-- Add Expense Form -->
        <div class="bg-white rounded-xl shadow-md p-5 border border-slate-200 mb-6">
            <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                ‚ûï Add Expense
            </h2>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1">üìÖ Date</label>
                        <input type="date" id="date" class="w-full px-3 py-2 text-sm rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1">üë§ Paid By</label>
                        <select id="paidBy" class="w-full px-3 py-2 text-sm rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="Bhavish">Bhavish</option>
                            <option value="Khushboo">Khushboo</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">üìç Where</label>
                    <input type="text" id="place" placeholder="Restaurant, Store, etc." class="w-full px-3 py-2 text-sm rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1">üíµ Amount (‚Çπ)</label>
                        <input type="number" id="amount" step="0.01" placeholder="0.00" class="w-full px-3 py-2 text-sm rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1">üè∑Ô∏è Category</label>
                        <select id="category" class="w-full px-3 py-2 text-sm rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="Food">Food</option>
                            <option value="Transport">Transport</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Bills">Bills</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Health">Health</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <button onclick="addExpense()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition-colors text-sm">
                    Add Expense
                </button>
            </div>
        </div>

        <!-- Recent Expenses -->
        <div class="bg-white rounded-xl shadow-md p-5 border border-slate-200 mb-6">
            <h2 class="text-lg font-bold text-slate-800 mb-4">üìã Recent Expenses</h2>
            <div id="expensesList"></div>
        </div>

        <!-- Analytics Header -->
        <div class="bg-white rounded-xl shadow-md p-5 border border-slate-200 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-slate-800">üìä Analytics</h2>
                <div class="flex gap-1 bg-slate-100 rounded-lg p-1">
                    <button onclick="setTimeFilter('Week')" id="filterWeek" class="px-3 py-1 rounded-md text-xs font-medium transition-colors text-slate-600 hover:text-slate-800">Week</button>
                    <button onclick="setTimeFilter('Month')" id="filterMonth" class="px-3 py-1 rounded-md text-xs font-medium transition-colors bg-blue-500 text-white">Month</button>
                    <button onclick="setTimeFilter('Year')" id="filterYear" class="px-3 py-1 rounded-md text-xs font-medium transition-colors text-slate-600 hover:text-slate-800">Year</button>
                </div>
            </div>
            <p class="text-xs text-slate-500" id="filterDescription">Showing expenses for: Current month</p>
        </div>

        <!-- Total Expenses -->
        <div class="bg-white rounded-xl shadow-md p-5 border border-slate-200 mb-3">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-slate-600 text-sm font-medium mb-1">Total Expenses</h3>
                    <p class="text-3xl font-bold text-slate-800" id="totalExpenses">‚Çπ0.00</p>
                </div>
                <span class="text-4xl">üí∞</span>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-white rounded-xl shadow-md p-4 border border-slate-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xl">üìà</span>
                </div>
                <p class="text-2xl font-bold text-slate-800" id="totalEntries">0</p>
                <p class="text-xs text-slate-600">Entries</p>
            </div>
            <div class="bg-white rounded-xl shadow-md p-4 border border-slate-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xl">üè∑Ô∏è</span>
                </div>
                <p class="text-2xl font-bold text-slate-800" id="topCategory">None</p>
                <p class="text-xs text-slate-600">Top Category</p>
            </div>
        </div>

        <!-- Who Paid What -->
        <div class="bg-white rounded-xl shadow-md p-5 border border-slate-200 mb-6">
            <h3 class="text-base font-bold text-slate-800 mb-3">üí≥ Who Paid What</h3>
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-700">Bhavish</span>
                    <span class="font-bold text-slate-700" id="bhavishTotal">‚Çπ0.00</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-rose-100 text-rose-700">Khushboo</span>
                    <span class="font-bold text-slate-700" id="khushbooTotal">‚Çπ0.00</span>
                </div>
            </div>
        </div>

        <!-- Top Categories -->
        <div class="bg-white rounded-xl shadow-md p-5 border border-slate-200 mb-6" id="topCategoriesCard" style="display: none;">
            <h3 class="text-base font-bold text-slate-800 mb-3">üéØ Top Categories</h3>
            <div id="topCategoriesList"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://epjulkezgiofkrdhvfqr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwanVsa2V6Z2lvZmtyZGh2ZnFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MjQzOTQsImV4cCI6MjA4MTIwMDM5NH0.DuIxOGe7uzVi04VkRd4bftcyC8QyiEoluCXyYvS05C4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let expenses = [];
        let timeFilter = 'Month';

        const categoryColors = {
            'Food': 'bg-orange-100 text-orange-700',
            'Transport': 'bg-blue-100 text-blue-700',
            'Shopping': 'bg-purple-100 text-purple-700',
            'Bills': 'bg-red-100 text-red-700',
            'Entertainment': 'bg-pink-100 text-pink-700',
            'Health': 'bg-green-100 text-green-700',
            'Other': 'bg-gray-100 text-gray-700'
        };

        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();

        // Load expenses on page load
        loadExpenses();

        // Set up real-time subscription
        supabase
            .channel('expenses-changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, () => {
                loadExpenses();
            })
            .subscribe();

        async function loadExpenses() {
            try {
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .order('date', { ascending: false });

                if (error) throw error;
                expenses = data || [];
                renderExpenses();
                updateAnalytics();
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        async function addExpense() {
            const date = document.getElementById('date').value;
            const place = document.getElementById('place').value;
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            const paidBy = document.getElementById('paidBy').value;

            if (!place || !amount) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const { error } = await supabase
                    .from('expenses')
                    .insert([{
                        date,
                        place,
                        amount: parseFloat(amount),
                        category,
                        paid_by: paidBy
                    }]);

                if (error) throw error;

                // Clear form
                document.getElementById('place').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('date').valueAsDate = new Date();
            } catch (error) {
                console.error('Error adding expense:', error);
                alert('Failed to add expense');
            }
        }

        async function deleteExpense(id) {
            if (!confirm('Delete this expense?')) return;

            try {
                const { error } = await supabase
                    .from('expenses')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
            } catch (error) {
                console.error('Error deleting expense:', error);
                alert('Failed to delete expense');
            }
        }

        function renderExpenses() {
            const list = document.getElementById('expensesList');
            
            if (expenses.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <div class="text-4xl mb-3">üí∏</div>
                        <p class="text-sm">No expenses yet. Start tracking!</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = expenses.map(exp => `
                <div class="p-4 rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors mb-3">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                            <p class="font-semibold text-slate-800 mb-1">${exp.place}</p>
                            <div class="flex flex-wrap gap-2 mb-2">
                                <span class="px-2 py-0.5 rounded-full text-xs font-medium ${categoryColors[exp.category]}">${exp.category}</span>
                                <span class="px-2 py-0.5 rounded-full text-xs font-medium ${exp.paid_by === 'Bhavish' ? 'bg-indigo-100 text-indigo-700' : 'bg-rose-100 text-rose-700'}">${exp.paid_by}</span>
                            </div>
                            <p class="text-xs text-slate-500">${exp.date}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <p class="font-bold text-slate-800 text-lg">‚Çπ${exp.amount.toFixed(2)}</p>
                            <button onclick="deleteExpense(${exp.id})" class="text-red-500 hover:text-red-700 transition-colors text-xl">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getFilteredExpenses() {
            const now = new Date();
            return expenses.filter(exp => {
                const expDate = new Date(exp.date);
                
                if (timeFilter === 'Week') {
                    const weekAgo = new Date(now);
                    weekAgo.setDate(now.getDate() - 7);
                    return expDate >= weekAgo;
                } else if (timeFilter === 'Month') {
                    return expDate.getMonth() === now.getMonth() && 
                           expDate.getFullYear() === now.getFullYear();
                } else if (timeFilter === 'Year') {
                    return expDate.getFullYear() === now.getFullYear();
                }
                return true;
            });
        }

        function setTimeFilter(filter) {
            timeFilter = filter;
            
            // Update button styles
            document.getElementById('filterWeek').className = 'px-3 py-1 rounded-md text-xs font-medium transition-colors ' + (filter === 'Week' ? 'bg-blue-500 text-white' : 'text-slate-600 hover:text-slate-800');
            document.getElementById('filterMonth').className = 'px-3 py-1 rounded-md text-xs font-medium transition-colors ' + (filter === 'Month' ? 'bg-blue-500 text-white' : 'text-slate-600 hover:text-slate-800');
            document.getElementById('filterYear').className = 'px-3 py-1 rounded-md text-xs font-medium transition-colors ' + (filter === 'Year' ? 'bg-blue-500 text-white' : 'text-slate-600 hover:text-slate-800');
            
            // Update description
            const descriptions = {
                'Week': 'Last 7 days',
                'Month': 'Current month',
                'Year': 'Current year'
            };
            document.getElementById('filterDescription').textContent = 'Showing expenses for: ' + descriptions[filter];
            
            updateAnalytics();
        }

        function updateAnalytics() {
            const filtered = getFilteredExpenses();
            const total = filtered.reduce((sum, exp) => sum + exp.amount, 0);
            
            document.getElementById('totalExpenses').textContent = '‚Çπ' + total.toFixed(2);
            document.getElementById('totalEntries').textContent = filtered.length;

            // Category totals
            const categoryTotals = {};
            filtered.forEach(exp => {
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
            });

            const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
            document.getElementById('topCategory').textContent = sortedCategories[0]?.[0] || 'None';

            // Person totals
            const bhavishTotal = filtered.filter(e => e.paid_by === 'Bhavish').reduce((sum, e) => sum + e.amount, 0);
            const khushbooTotal = filtered.filter(e => e.paid_by === 'Khushboo').reduce((sum, e) => sum + e.amount, 0);
            
            document.getElementById('bhavishTotal').textContent = '‚Çπ' + bhavishTotal.toFixed(2);
            document.getElementById('khushbooTotal').textContent = '‚Çπ' + khushbooTotal.toFixed(2);

            // Top categories
            if (sortedCategories.length > 0) {
                document.getElementById('topCategoriesCard').style.display = 'block';
                document.getElementById('topCategoriesList').innerHTML = sortedCategories.slice(0, 3).map(([cat, amt]) => `
                    <div class="flex items-center justify-between mb-2">
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${categoryColors[cat]}">${cat}</span>
                        <span class="font-semibold text-slate-700 text-sm">‚Çπ${amt.toFixed(2)}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('topCategoriesCard').style.display = 'none';
            }
        }
    </script>
</body>
</html>
